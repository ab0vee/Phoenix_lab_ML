# Telegram Bot - Подробная документация

## Содержание

1. [Обзор](#обзор)
2. [Библиотека aiogram](#библиотека-aiogram)
3. [Архитектура бота](#архитектура-бота)
4. [Функционал](#функционал)
5. [Состояния (FSM)](#состояния-fsm)
6. [Команды](#команды)
7. [Интеграция с API](#интеграция-с-api)

---

## Обзор

Telegram Bot Phoenix LAB предназначен для управления Telegram каналами, авторизации пользователей и отправки обработанных статей в каналы.

**Основные возможности:**
- Управление списком каналов
- Авторизация пользователей через токены
- Отправка статей в каналы
- Генерация токенов для авторизации в веб-интерфейсе

---

## Библиотека aiogram

### Почему aiogram?

**Преимущества aiogram 3.x:**

1. **Асинхронность**
   - ✅ Нативная поддержка async/await
   - ✅ Высокая производительность
   - ✅ Эффективная обработка множества запросов

2. **Современный API**
   - ✅ Интуитивный и понятный синтаксис
   - ✅ Type hints для типизации
   - ✅ Удобная работа с обработчиками

3. **FSM (Finite State Machine)**
   - ✅ Встроенная поддержка состояний
   - ✅ Удобное управление диалогами
   - ✅ Сохранение состояния между сообщениями

4. **Активное развитие**
   - ✅ Регулярные обновления
   - ✅ Исправление багов
   - ✅ Новые функции

5. **Хорошая документация**
   - ✅ Подробная документация
   - ✅ Примеры кода
   - ✅ Большое сообщество

### Сравнение с другими библиотеками

**python-telegram-bot:**
- ❌ Менее современный API
- ❌ Меньше асинхронных возможностей
- ❌ Сложнее работа с состояниями

**telethon:**
- ❌ Client API вместо Bot API
- ❌ Более низкоуровневый
- ❌ Сложнее для простых ботов

**aiogram:**
- ✅ Современный async API
- ✅ Встроенная FSM
- ✅ Простота использования

---

## Архитектура бота

### Структура

```
backend/telegram_bot/
├── main.py           # Главный файл бота
├── channels.json     # Список каналов (JSON файл)
├── auth_tokens.json  # Токены авторизации (JSON файл)
└── requirements.txt  # Зависимости
```

### Инициализация

```python
from aiogram import Bot, Dispatcher
from aiogram.fsm.storage.memory import MemoryStorage

bot = Bot(token=BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)
```

**Компоненты:**
- **Bot** - клиент для работы с Telegram Bot API
- **Dispatcher** - обработчик событий и команд
- **Storage** - хранилище состояний (MemoryStorage - в памяти)

---

### Файлы данных

#### channels.json

Хранит список каналов:

```json
{
    "channels": [
        {
            "id": "@channel1",
            "name": "Название канала"
        }
    ]
}
```

**Функции:**
- `load_channels()` - загрузка списка
- `save_channels()` - сохранение списка
- `add_channel()` - добавление канала
- `remove_channel()` - удаление канала

#### auth_tokens.json

Хранит токены авторизации:

```json
{
    "tokens": {
        "abc123...": {
            "authorized": true,
            "user_data": {
                "id": 123456,
                "username": "user123"
            },
            "created_at": "2024-01-01T00:00:00"
        }
    }
}
```

**Функции:**
- `load_auth_tokens()` - загрузка токенов
- `save_auth_tokens()` - сохранение токенов
- `authorize_token()` - авторизация токена
- `verify_auth_token()` - проверка токена

---

## Функционал

### Управление каналами

#### Добавление канала

**Команда:** `/add_channel`

**Процесс:**
1. Пользователь отправляет `/add_channel`
2. Бот просит переслать сообщение из канала или отправить @username
3. Бот проверяет, является ли он администратором канала
4. Бот добавляет канал в список
5. Бот сохраняет список в `channels.json`

**Код:**
```python
@dp.message(Command("add_channel"))
async def cmd_add_channel(message: Message, state: FSMContext):
    await message.answer("Перешлите сообщение из канала или отправьте @username канала")
    await state.set_state(AddChannel.waiting_for_channel)
```

#### Удаление канала

**Команда:** `/remove_channel`

**Процесс:**
1. Пользователь отправляет `/remove_channel`
2. Бот показывает список каналов с inline кнопками
3. Пользователь выбирает канал
4. Бот удаляет канал из списка

#### Список каналов

**Команда:** `/channels`

**Процесс:**
1. Пользователь отправляет `/channels`
2. Бот показывает список всех каналов

---

### Авторизация пользователей

#### Генерация токена

**Команда:** `/generate_token`

**Процесс:**
1. Пользователь отправляет `/generate_token`
2. Бот генерирует уникальный токен
3. Бот отправляет токен пользователю
4. Токен используется для авторизации в веб-интерфейсе

**Интеграция с API:**
- Токен отправляется в `/api/auth/generate-token`
- API возвращает токен
- Бот сохраняет токен в `auth_tokens.json`

#### Авторизация через токен

**Процесс:**
1. Пользователь входит в веб-интерфейс
2. Веб-интерфейс проверяет токен через `/api/auth/verify-token`
3. Если токен валидный, пользователь авторизуется
4. Токен привязывается к данным пользователя Telegram

**API вызов:**
```python
await authorize_token(token, user_data)
# Отправка POST /api/auth/authorize
```

---

### Отправка статей в каналы

**API эндпоинт:** `/api/send-article`

**Процесс:**
1. Веб-интерфейс отправляет статью через API
2. API вызывает функцию отправки через Telegram Bot API
3. Бот отправляет статью в указанные каналы

**Код:**
```python
async def send_to_channel(channel_id: str, text: str, image_url: str = None):
    try:
        if image_url:
            await bot.send_photo(channel_id, image_url, caption=text)
        else:
            await bot.send_message(channel_id, text)
        return True
    except Exception as e:
        logger.error(f"Ошибка отправки в канал {channel_id}: {e}")
        return False
```

---

## Состояния (FSM)

### Добавление канала (AddChannel)

**Состояния:**
- `waiting_for_channel` - ожидание данных канала

**Процесс:**
```python
class AddChannel(StatesGroup):
    waiting_for_channel = State()

@dp.message(Command("add_channel"))
async def cmd_add_channel(message: Message, state: FSMContext):
    await state.set_state(AddChannel.waiting_for_channel)

@dp.message(AddChannel.waiting_for_channel)
async def process_channel(message: Message, state: FSMContext):
    # Обработка данных канала
    await state.clear()
```

---

## Команды

### /start

**Описание:** Приветственное сообщение

**Ответ:**
```
Привет! Я бот Phoenix LAB.
Используйте /help для списка команд.
```

---

### /help

**Описание:** Список доступных команд

**Ответ:**
```
Доступные команды:
/add_channel - добавить канал
/remove_channel - удалить канал
/channels - список каналов
/generate_token - сгенерировать токен авторизации
/help - показать эту справку
```

---

### /add_channel

**Описание:** Добавить канал для публикации

**Процесс:**
1. Бот просит переслать сообщение из канала или отправить @username
2. Бот проверяет администраторские права
3. Бот добавляет канал в список

---

### /remove_channel

**Описание:** Удалить канал из списка

**Процесс:**
1. Бот показывает список каналов с inline кнопками
2. Пользователь выбирает канал
3. Бот удаляет канал

---

### /channels

**Описание:** Показать список всех каналов

**Ответ:**
Список каналов из `channels.json`

---

### /generate_token

**Описание:** Сгенерировать токен для авторизации в веб-интерфейсе

**Процесс:**
1. Бот генерирует уникальный токен
2. Бот отправляет токен пользователю
3. Токен можно использовать в веб-интерфейсе

---

## Интеграция с API

### Rewrite Service

**URL:** `http://rewrite_service:5000`

**Эндпоинты:**
- `POST /api/auth/authorize` - авторизация токена
- `POST /api/send-article` - отправка статьи

**Использование:**
```python
import aiohttp

async with aiohttp.ClientSession() as session:
    async with session.post(
        f"{API_URL}/api/auth/authorize",
        json={"token": token, "user_data": user_data}
    ) as response:
        result = await response.json()
```

---

### Отправка статей

**Процесс:**
1. Веб-интерфейс вызывает `/api/send-article`
2. Rewrite Service вызывает функцию отправки через бота
3. Бот отправляет сообщение в каналы

**Код в Rewrite Service:**
```python
async def send_to_telegram_channels(channel_ids, text, image_url=None):
    from aiogram import Bot
    bot = Bot(token=BOT_TOKEN)
    for channel_id in channel_ids:
        await bot.send_message(channel_id, text)
```

---

## Особенности реализации

### Хранение данных

**JSON файлы:**
- `channels.json` - список каналов
- `auth_tokens.json` - токены авторизации

**Преимущества:**
- Простота реализации
- Легко редактировать
- Не требует БД

**Недостатки:**
- Нет транзакций
- Потенциальные проблемы при конкурентном доступе (для будущего улучшения)

---

### Обработка ошибок

**Типы ошибок:**
- Ошибки Telegram API
- Ошибки сети
- Ошибки валидации

**Обработка:**
- Логирование всех ошибок
- Понятные сообщения пользователю
- Graceful degradation

---

### Безопасность

**Проверки:**
- Валидация токенов
- Проверка администраторских прав
- Проверка формата данных

**Защита:**
- Токены хранятся в безопасном формате
- Проверка прав доступа перед операциями

---

## Примеры использования

### Добавление канала

```
Пользователь: /add_channel
Бот: Перешлите сообщение из канала или отправьте @username канала
Пользователь: @my_channel
Бот: ✅ Канал @my_channel успешно добавлен!
```

### Генерация токена

```
Пользователь: /generate_token
Бот: Ваш токен авторизации: abc123def456...
Используйте этот токен в веб-интерфейсе для авторизации.
```

---

## Заключение

Telegram Bot Phoenix LAB предоставляет удобный интерфейс для управления каналами и авторизации пользователей. Библиотека aiogram обеспечивает производительность и удобство разработки благодаря асинхронности и встроенной поддержке FSM.

Интеграция с Rewrite Service позволяет отправлять обработанные статьи прямо из веб-интерфейса в Telegram каналы.

