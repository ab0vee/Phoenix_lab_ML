# LLM Модели - Принцип работы и функционал

## Содержание

1. [Обзор](#обзор)
2. [Используемые LLM модели](#используемые-llm-модели)
3. [Принцип работы](#принцип-работы)
4. [Интеграция с API](#интеграция-с-api)
5. [Промпты и обработка ответов](#промпты-и-обработка-ответов)
6. [Сравнение с ML моделями](#сравнение-с-ml-моделями)

---

## Обзор

Помимо локальных ML моделей (NLP), система использует **LLM (Large Language Models)** через внешние API для более качественного рерайта текстов. LLM модели предоставляют более гибкую обработку и лучший контроль над стилем вывода.

### Основные преимущества LLM:

- **Более качественный рерайт** - лучшее понимание контекста
- **Гибкость стилей** - возможность точной настройки стиля вывода
- **Работа с длинными текстами** - обработка текстов любой длины
- **Многоязычность** - работа с различными языками из коробки

---

## Используемые LLM модели

### 1. Qwen 2.5 72B Instruct (через OpenRouter)

**Описание:**
- Модель: `qwen/qwen2.5-72b-instruct`
- Провайдер: OpenRouter API
- Размер: 72 миллиарда параметров
- Языки: Многоязычная (русский, английский и др.)

**Характеристики:**
- Высокое качество понимания контекста
- Отличное качество для русскоязычных текстов
- Быстрая генерация
- Доступ через OpenRouter (аггрегатор LLM API)

**Использование:**
```python
rewritten = rewrite_article_with_openrouter(article_text, style="scientific")
```

**Параметры:**
- `temperature`: 0.5 (баланс между качеством и разнообразием)
- `max_tokens`: 4000 (достаточно для длинных текстов)
- `top_p`: 0.95

### 2. YandexGPT (через Yandex Cloud API)

**Описание:**
- Модель: YandexGPT (проприетарная модель Яндекса)
- Провайдер: Yandex Cloud API (REST Assistant API)
- Специализация: Русскоязычные тексты
- Преимущество: Оптимизирована для русского языка

**Характеристики:**
- Отличное качество для русскоязычных текстов
- Понимание русской культуры и контекста
- Быстрая генерация
- Нативная поддержка русского языка

**Использование:**
```python
rewritten = rewrite_article_with_yandexgpt(article_text, style="casual")
```

**Параметры:**
- Управляются через Yandex Cloud API
- Автоматическая оптимизация под русский язык

---

## Принцип работы

### Общая схема

```
Пользовательский запрос
    ↓
Rewrite Service (Flask)
    ↓
Выбор провайдера (OpenRouter / YandexGPT)
    ↓
Формирование промпта с указанием стиля
    ↓
Отправка запроса в LLM API
    ↓
Получение ответа
    ↓
Очистка от артефактов и мыслей модели
    ↓
Возврат обработанного текста
```

### Выбор провайдера

Система выбирает провайдера на основе:
1. **Настроек пользователя** (выбор модели в интерфейсе)
2. **Доступности API ключей**
3. **Типа задачи** (рерайт, суммаризация)

### Определение стиля

Доступные стили рерайта:

1. **НАУЧНО-ДЕЛОВОЙ** (`scientific`)
   - Формальный язык
   - Объективность
   - Научная терминология
   - Без эмоций

2. **МЕМНЫЙ** (`meme`)
   - Интернет-мемы
   - Эмодзи
   - Сленг
   - Сарказм
   - Неформальный стиль

3. **ПОВСЕДНЕВНЫЙ** (`casual`)
   - Простое объяснение
   - Естественный язык
   - Разговорный стиль
   - Доступность

---

## Интеграция с API

### OpenRouter API

**Настройка:**
```python
OPENROUTER_API_KEY = os.getenv('OPENROUTER_API_KEY')
OPENROUTER_API_URL = 'https://openrouter.ai/api/v1/chat/completions'
OPENROUTER_MODEL = 'qwen/qwen2.5-72b-instruct'
```

**Запрос:**
```python
headers = {
    'Authorization': f'Bearer {OPENROUTER_API_KEY}',
    'Content-Type': 'application/json',
    'HTTP-Referer': 'https://phoenix-lab.com',
    'X-Title': 'Phoenix Lab'
}

payload = {
    "model": OPENROUTER_MODEL,
    "messages": [
        {
            "role": "system",
            "content": "Ты — инструмент для рерайта текстов..."
        },
        {
            "role": "user",
            "content": f"Перепиши следующий текст в стиле {style_name}:\n\n{article_text}"
        }
    ],
    "temperature": 0.5,
    "max_tokens": 4000,
    "top_p": 0.95,
    "stop": ["\nДумаю:", "\nВот переписанный текст:", "\nThink:", "\n("]
}

response = requests.post(OPENROUTER_API_URL, headers=headers, json=payload, timeout=60)
```

**Особенности:**
- Использует OpenAI-совместимый API
- Поддержка множества моделей через один интерфейс
- Гибкая настройка параметров

### Yandex Cloud API

**Настройка:**
```python
YANDEX_CLOUD_API_KEY = os.getenv('YANDEX_CLOUD_API_KEY')
YANDEX_CLOUD_PROJECT = os.getenv('YANDEX_CLOUD_PROJECT', 'b1goig30m707ojip72c7')
YANDEX_CLOUD_ASSISTANT_ID = os.getenv('YANDEX_CLOUD_ASSISTANT_ID', 'fvtfdp5dm8r044bnumjl')
```

**Инициализация клиента:**
```python
from openai import OpenAI

yandex_client = OpenAI(
    api_key=YANDEX_CLOUD_API_KEY,
    base_url="https://rest-assistant.api.cloud.yandex.net/v1"
)

yandex_default_headers = {
    "x-folder-id": YANDEX_CLOUD_PROJECT
}
```

**Запрос:**
```python
response = yandex_client.responses.create(
    prompt={
        "id": YANDEX_CLOUD_ASSISTANT_ID,
    },
    input=full_prompt,
    extra_headers={
        "x-folder-id": YANDEX_CLOUD_PROJECT
    }
)

result_text = response.output_text
```

**Особенности:**
- Использует OpenAI SDK (совместимость)
- Оптимизация для русского языка
- Работа через Assistant ID (преднастроенный промпт)

---

## Промпты и обработка ответов

### System Prompt (OpenRouter)

Системный промпт инструктирует модель о ее роли и правилах:

```python
system_prompt = """Ты — инструмент для рерайта текстов. Твоя единственная задача — переписать предоставленный текст в указанном стиле БЕЗ МЫСЛЕЙ.

Доступные стили:
- НАУЧНО-ДЕЛОВОЙ: формально, объективно, научная терминология
- МЕМНЫЙ: интернет-мемы, эмодзи, сленг, сарказм
- ПОВСЕДНЕВНЫЙ: просто, естественно, разговорно

ПРАВИЛА:
1. Отвечай ТОЛЬКО переписанным текстом
2. НИКАКИХ объяснений, комментариев, предисловий
3. НИКАКИХ фраз типа "Вот текст:", "Переписанный вариант:", "Думаю:" и т.п.
4. НИКАКИХ мыслей, рассуждений, мета-комментариев
5. НИКАКИХ кавычек вокруг текста
6. Начинай сразу с переписанного текста
7. Сохраняй смысл оригинала
8. Длина примерно как у оригинала"""
```

### User Prompt

Пользовательский промпт содержит сам текст для рерайта:

```python
user_prompt = f"Перепиши следующий текст в стиле {style_name}:\n\n{article_text}"
```

### Обработка ответа

После получения ответа от LLM выполняется очистка:

```python
def clean_model_response(text: str) -> str:
    """Очистка ответа модели от артефактов"""
    
    # Удаление мыслей модели
    text = re.sub(r'Думаю[:\s]*[^\.]*\.', '', text, flags=re.IGNORECASE)
    text = re.sub(r'Think[:\s]*[^\.]*\.', '', text, flags=re.IGNORECASE)
    
    # Удаление предисловий
    text = re.sub(r'^Вот переписанный текст[:\s]*', '', text, flags=re.IGNORECASE)
    text = re.sub(r'^Переписанный вариант[:\s]*', '', text, flags=re.IGNORECASE)
    
    # Удаление кавычек в начале и конце
    text = text.strip().strip('"').strip("'")
    
    # Удаление лишних пробелов
    text = re.sub(r'\s+', ' ', text)
    
    return text.strip()
```

### Стоп-последовательности

Для предотвращения генерации нежелательного контента используются стоп-последовательности:

```python
"stop": [
    "\nДумаю:",
    "\nВот переписанный текст:",
    "\nThink:",
    "\n("
]
```

Это останавливает генерацию, если модель начинает добавлять комментарии или мысли.

---

## Сравнение с ML моделями

### ML Модели (NLP) vs LLM Модели

| Характеристика | ML Модели (NLP) | LLM Модели |
|----------------|-----------------|------------|
| **Скорость** | Быстро (2-5 сек) | Медленнее (5-15 сек) |
| **Качество** | Хорошее | Отличное |
| **Стили** | Фиксированные | Гибкие, настраиваемые |
| **Длина текста** | Ограничена (~512 токенов) | Без ограничений |
| **Стоимость** | Бесплатно | Платно (API) |
| **Офлайн работа** | Да | Нет (требует API) |
| **Языки** | Русский/Английский | Множество языков |

### Когда использовать ML модели:

- ✅ Нужна высокая скорость обработки
- ✅ Офлайн работа
- ✅ Бесплатная обработка
- ✅ Короткие тексты
- ✅ Простое парафразирование

### Когда использовать LLM модели:

- ✅ Нужно высокое качество
- ✅ Требуется точная настройка стиля
- ✅ Длинные тексты
- ✅ Сложный контент
- ✅ Многоязычные тексты

---

## Функционал

### Рерайт через Qwen (OpenRouter)

**Эндпоинт:** `/api/rewrite-article`

**Параметры запроса:**
```json
{
    "url": "https://example.com/article",
    "text": "Исходный текст...",
    "style": "scientific|casual|meme",
    "provider": "openrouter"
}
```

**Процесс:**
1. Извлечение текста из URL (если указан) или использование прямого текста
2. Проверка доступности OpenRouter API ключа
3. Формирование промпта с указанием стиля
4. Отправка запроса в OpenRouter API
5. Очистка ответа от артефактов
6. Возврат обработанного текста

### Рерайт через YandexGPT

**Эндпоинт:** `/api/rewrite-article`

**Параметры запроса:**
```json
{
    "url": "https://example.com/article",
    "text": "Исходный текст...",
    "style": "scientific|casual|meme",
    "provider": "yandex"
}
```

**Процесс:**
1. Извлечение текста из URL (если указан) или использование прямого текста
2. Проверка доступности YandexGPT API ключа
3. Формирование промпта
4. Отправка запроса в Yandex Cloud API через OpenAI-совместимый клиент
5. Очистка ответа от артефактов
6. Возврат обработанного текста

---

## Ограничения и известные проблемы

### Ограничения

1. **Зависимость от API:**
   - Требуется стабильное интернет-соединение
   - Зависимость от доступности API провайдера
   - Ограничения по rate limit

2. **Стоимость:**
   - Каждый запрос стоит денег
   - Накопление расходов при большом объеме

3. **Задержки:**
   - Сетевая задержка
   - Время обработки на стороне провайдера

### Известные проблемы

1. **Мысли модели:**
   - Иногда модель добавляет комментарии
   - Решение: функция `clean_model_response()` и стоп-последовательности

2. **Изменение длины:**
   - Модель может значительно изменить длину текста
   - Решение: явное указание в промпте сохранять длину

3. **Потеря информации:**
   - Модель может пропустить важные детали
   - Решение: использование более детальных промптов

---

## Примеры использования

### Рерайт через OpenRouter API

```python
import requests

response = requests.post(
    "http://localhost:5000/api/rewrite-article",
    json={
        "text": "Исходный текст для рерайта...",
        "style": "scientific",
        "provider": "openrouter"
    }
)

result = response.json()
print(result["text"])  # Переписанный текст
```

### Рерайт через YandexGPT API

```python
import requests

response = requests.post(
    "http://localhost:5000/api/rewrite-article",
    json={
        "text": "Исходный текст для рерайта...",
        "style": "casual",
        "provider": "yandex"
    }
)

result = response.json()
print(result["text"])  # Переписанный текст
```

---

## Заключение

LLM модели предоставляют мощный инструмент для качественного рерайта текстов с гибкой настройкой стиля. Интеграция с OpenRouter и Yandex Cloud API позволяет использовать лучшие модели без необходимости собственной инфраструктуры.

Выбор между ML и LLM моделями зависит от требований к скорости, качеству, стоимости и доступности интернета.

